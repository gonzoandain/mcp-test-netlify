---
phase: 04-header-routing-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify/functions/mcp.ts
  - README.md
autonomous: true

must_haves:
  truths:
    - "Request with X-Client-ID header logs deprecation warning to console"
    - "Request without X-Client-ID header processes normally (no warning)"
    - "README documents clientId parameter approach"
  artifacts:
    - path: "netlify/functions/mcp.ts"
      provides: "MCP handler with deprecation warning for X-Client-ID header"
      contains: "X-Client-ID header is deprecated"
    - path: "README.md"
      provides: "Updated documentation for clientId-only approach"
      contains: "clientId"
  key_links:
    - from: "netlify/functions/mcp.ts"
      to: "console.warn"
      via: "deprecation logging"
      pattern: "console\\.warn.*deprecated"
---

<objective>
Add deprecation warning for X-Client-ID header and update README for clientId-only approach.

Purpose: Provide migration path for existing integrations while documenting the new clientId parameter approach.
Output: Updated handler with deprecation warning, updated documentation.
</objective>

<execution_context>
@/Users/gonzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gonzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-header-routing-cleanup/04-CONTEXT.md
@.planning/phases/04-header-routing-cleanup/04-RESEARCH.md
@netlify/functions/mcp.ts
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add X-Client-ID deprecation warning</name>
  <files>netlify/functions/mcp.ts</files>
  <action>
Add deprecation warning check early in the handler function (after the POST method check, before getOrCreateServer()).

Per CONTEXT.md decisions:
- Log to console so server logs show deprecation usage
- Warning message: "X-Client-ID header is deprecated"
- Do NOT reject the request - just warn and continue
- Do NOT add warning to MCP response content (per research, this adds complexity for minimal value since tools work via clientId now anyway)

Add after line 35 (after POST method check):

```typescript
    // Deprecation warning for legacy header-based routing
    const clientIdHeader = req.headers.get('x-client-id');
    if (clientIdHeader) {
      console.warn('X-Client-ID header is deprecated');
    }
```

This satisfies CLEN-01 (remove X-Client-ID validation) because:
- We no longer validate or use the header for routing
- We only log a warning for observability during migration
- The header is effectively ignored for routing purposes
  </action>
  <verify>
Run: `grep -n "deprecated" netlify/functions/mcp.ts` - should show deprecation warning code
Run: `npx tsc --noEmit` - should compile without errors
  </verify>
  <done>mcp.ts logs deprecation warning when X-Client-ID header present</done>
</task>

<task type="auto">
  <name>Task 2: Update README for clientId approach</name>
  <files>README.md</files>
  <action>
Update README.md to reflect clientId-only approach. Make these changes:

1. In "Setup" section (around line 19-24), replace environment variables section:
```markdown
2. **Configure environment variables**:
   Create a `.env` file or set in Netlify dashboard:
   ```env
   CLIENTS_CONFIG={"client1":{"name":"Client One","coreBase":"https://...","clientBase":"https://..."}}
   ```

   Each client needs: `name`, `coreBase`, `clientBase` URLs.
```

2. Add new "Multi-Client Usage" section after "Available Tools" (around line 55):
```markdown
## Multi-Client Usage

All tools accept a `clientId` parameter as the first argument to identify which client configuration to use.

### Discovering Clients

Use the `list_clients` tool to see all available clients:
```json
{
  "method": "tools/call",
  "params": {
    "name": "list_clients",
    "arguments": {}
  }
}
```

### Example Tool Call

```json
{
  "method": "tools/call",
  "params": {
    "name": "core_list_sucursales",
    "arguments": {
      "clientId": "client1"
    }
  }
}
```

**Note**: The `X-Client-ID` header is deprecated. Use the `clientId` parameter instead.
```

3. Remove outdated environment variable examples that reference single-client config (CORE_BASE, CLIENT_BASE).

Keep the README concise - no need to document every tool's parameters, just the clientId pattern.
  </action>
  <verify>
Run: `grep -n "clientId" README.md` - should show clientId documentation
Run: `grep -n "X-Client-ID" README.md` - should show deprecation note only (not usage instructions)
Run: `grep "CORE_BASE\|CLIENT_BASE" README.md` - should return no matches (removed)
  </verify>
  <done>README documents clientId parameter approach, deprecates X-Client-ID header</done>
</task>

</tasks>

<verification>
1. mcp.ts contains deprecation warning for X-Client-ID header
2. README documents clientId parameter approach
3. README does not instruct users to use X-Client-ID header
4. `npx tsc --noEmit` compiles successfully
</verification>

<success_criteria>
- mcp.ts logs console.warn when X-Client-ID header present
- README updated with clientId parameter documentation
- README contains deprecation note for X-Client-ID
- TypeScript builds without errors
- Requirements CLEN-01 and CLEN-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-header-routing-cleanup/04-02-SUMMARY.md`
</output>
