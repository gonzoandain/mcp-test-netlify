---
phase: 04-header-routing-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify/functions/mcp.ts
  - README.md
autonomous: true

must_haves:
  truths:
    - "Request with X-Client-ID header returns deprecation warning in MCP response"
    - "Request without X-Client-ID header processes normally (no warning)"
    - "README documents clientId parameter approach"
  artifacts:
    - path: "netlify/functions/mcp.ts"
      provides: "MCP handler with deprecation warning in response for X-Client-ID header"
      contains: "X-Client-ID header is deprecated"
    - path: "README.md"
      provides: "Updated documentation for clientId-only approach"
      contains: "clientId"
  key_links:
    - from: "netlify/functions/mcp.ts"
      to: "MCP response content"
      via: "deprecation warning injection"
      pattern: "deprecationWarning"
---

<objective>
Add deprecation warning for X-Client-ID header (returned in MCP response) and update README for clientId-only approach.

Purpose: Provide migration path for existing integrations while documenting the new clientId parameter approach.
Output: Updated handler with deprecation warning visible to LLM/client, updated documentation.
</objective>

<execution_context>
@/Users/gonzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gonzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-header-routing-cleanup/04-CONTEXT.md
@.planning/phases/04-header-routing-cleanup/04-RESEARCH.md
@netlify/functions/mcp.ts
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add X-Client-ID deprecation warning in MCP response</name>
  <files>netlify/functions/mcp.ts</files>
  <action>
Add deprecation warning that is returned in the MCP response so LLM/client sees it.

Per CONTEXT.md locked decisions:
- "Warning returned in MCP response (not just server console) so LLM/client sees it"
- Warning message: "X-Client-ID header is deprecated"
- Do NOT reject the request - just warn and continue
- Warning persists permanently until header check code is removed in future version

Implementation approach - inject warning into response when X-Client-ID header detected:

1. After line 35 (POST method check), detect the header:
```typescript
    // Check for deprecated X-Client-ID header
    const clientIdHeader = req.headers.get('x-client-id');
```

2. After getting the response from transport.handleRequest (around line 143-145), if header was present, inject deprecation warning into the response body before returning.

The response is already JSON. Parse it, add a deprecation field or prepend warning to any text content, then re-serialize.

Approach for injecting warning into MCP response:
```typescript
    // Handle the request with the appropriate transport
    await transport.handleRequest(nodeReq, nodeRes, body);

    // Get the response that was written to nodeRes
    let response = toFetchResponse(nodeRes);

    // If deprecated header was used, inject warning into response
    if (clientIdHeader) {
      console.warn('X-Client-ID header is deprecated'); // Also log for server visibility

      try {
        const responseBody = await response.clone().json();
        // For MCP responses with result.content array, prepend warning
        if (responseBody.result?.content && Array.isArray(responseBody.result.content)) {
          responseBody.result.content.unshift({
            type: 'text',
            text: '[DEPRECATION WARNING] X-Client-ID header is deprecated. Use clientId parameter in tool calls instead.'
          });
          response = new Response(JSON.stringify(responseBody), {
            status: response.status,
            headers: response.headers
          });
        }
      } catch {
        // If response isn't JSON or doesn't have expected structure, just return original
      }
    }

    return response;
```

This ensures the LLM/client sees the deprecation warning as part of the tool response content.
  </action>
  <verify>
Run: `grep -n "deprecated" netlify/functions/mcp.ts` - should show deprecation warning code
Run: `grep -n "DEPRECATION WARNING" netlify/functions/mcp.ts` - should show warning message
Run: `npx tsc --noEmit` - should compile without errors
  </verify>
  <done>mcp.ts returns deprecation warning in MCP response when X-Client-ID header present</done>
</task>

<task type="auto">
  <name>Task 2: Update README for clientId approach</name>
  <files>README.md</files>
  <action>
Update README.md to reflect clientId-only approach. Make these changes:

1. In "Setup" section (around line 19-24), replace environment variables section:
```markdown
2. **Configure environment variables**:
   Create a `.env` file or set in Netlify dashboard:
   ```env
   CLIENTS_CONFIG={"client1":{"name":"Client One","coreBase":"https://...","clientBase":"https://..."}}
   ```

   Each client needs: `name`, `coreBase`, `clientBase` URLs.
```

2. Add new "Multi-Client Usage" section after "Available Tools" (around line 55):
```markdown
## Multi-Client Usage

All tools accept a `clientId` parameter as the first argument to identify which client configuration to use.

### Discovering Clients

Use the `list_clients` tool to see all available clients:
```json
{
  "method": "tools/call",
  "params": {
    "name": "list_clients",
    "arguments": {}
  }
}
```

### Example Tool Call

```json
{
  "method": "tools/call",
  "params": {
    "name": "core_list_sucursales",
    "arguments": {
      "clientId": "client1"
    }
  }
}
```

**Note**: The `X-Client-ID` header is deprecated. Use the `clientId` parameter instead.
```

3. Remove outdated environment variable examples that reference single-client config (CORE_BASE, CLIENT_BASE).

Keep the README concise - no need to document every tool's parameters, just the clientId pattern.
  </action>
  <verify>
Run: `grep -n "clientId" README.md` - should show clientId documentation
Run: `grep -n "X-Client-ID" README.md` - should show deprecation note only (not usage instructions)
Run: `grep "CORE_BASE\|CLIENT_BASE" README.md` - should return no matches (removed)
  </verify>
  <done>README documents clientId parameter approach, deprecates X-Client-ID header</done>
</task>

</tasks>

<verification>
1. mcp.ts injects deprecation warning into MCP response when X-Client-ID header present
2. README documents clientId parameter approach
3. README does not instruct users to use X-Client-ID header
4. `npx tsc --noEmit` compiles successfully
</verification>

<success_criteria>
- mcp.ts returns deprecation warning in MCP response content when X-Client-ID header present
- README updated with clientId parameter documentation
- README contains deprecation note for X-Client-ID
- TypeScript builds without errors
- Requirements CLEN-01 and CLEN-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-header-routing-cleanup/04-02-SUMMARY.md`
</output>
